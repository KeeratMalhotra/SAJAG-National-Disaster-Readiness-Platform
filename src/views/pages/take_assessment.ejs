<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Assessment | <%= training.title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Keep your existing CSS */
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .assessment-container { max-width: 800px; margin: 40px auto; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .header-image { height: 200px; background-size: cover; background-position: center; position: relative; }
        .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; padding: 20px; }
        .title-text { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .question-card { margin-bottom: 20px; display: none; } /* Hidden by default */
        .question-card.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .option-label { display: block; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; }
        .option-input { display: none; }
        .option-input:checked + .option-label { border-color: #0d6efd; background-color: #f8fbff; }
        .btn-nav { width: 120px; }
        
        /* Result Card Styles */
        #result-card { display: none; animation: fadeIn 0.5s; }
        .score-circle { width: 150px; height: 150px; border-radius: 50%; background: #0d6efd; color: white; display: flex; align-items: center; justify-content: center; font-size: 3rem; margin: 0 auto; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h4 id="loading-text">Verifying your location...</h4>
        <p class="text-muted small" id="loading-subtext">Please allow location access to continue.</p>
        <button id="retry-btn" class="btn btn-outline-secondary btn-sm mt-3" style="display: none;" onclick="window.location.reload()">Retry</button>
    </div>

    <div class="assessment-container" id="main-content" style="display: none;">
        
        <div class="card p-5 text-center" id="result-card">
            <h2 class="mb-4">Assessment Complete</h2>
            <div class="score-circle mb-4" id="score-display">0%</div>
            <h4 id="result-message" class="mb-3"></h4>
            <div id="certificate-area" class="mt-3">
                </div>
            <a href="/dashboard" class="btn btn-link mt-3">Back to Dashboard</a>
        </div>

        <form id="assessmentForm">
            <input type="hidden" name="trainingId" value="<%= training.id %>">
            <input type="hidden" id="userLat" name="userLat">
            <input type="hidden" id="userLng" name="userLng">

            <div class="card mb-4" id="intro-card">
                <div class="header-image" style="background-image: url('/images/<%= training.theme %>.jpg'), url('/images/default.jpg');">
                    <div class="overlay">
                        <div class="title-text">
                            <h1><%= training.title %></h1>
                            <p class="mb-0"><i class="bi bi-geo-alt-fill"></i> <%= training.location_text %></p>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Training Partner ID</label>
                        <input type="text" class="form-control" value="<%= training.creator_user_id ? training.creator_user_id.slice(-12) : 'N/A' %>" readonly disabled style="background-color: #e9ecef; letter-spacing: 1px; font-family: monospace;">
                    </div>
                    
                    <h5 class="mb-3">Participant Details</h5>

                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="participantName" id="participantName" class="form-control" required placeholder="Enter your name">
                        <div class="invalid-feedback" id="nameFeedback">Name cannot contain numbers or symbols.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="participantEmail" id="participantEmail" class="form-control" required placeholder="name@gov.in">
                        <div class="invalid-feedback" id="emailFeedback">Invalid email format or restricted domain. Allowed: gov.in, nic.in</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Aadhar ID / आधार संख्या</label>
                        <input type="text" name="aadharId" id="aadharId" class="form-control form-control-lg" required maxlength="12" placeholder="12-digit Aadhar Number">
                        <div class="invalid-feedback">Aadhar ID must be exactly 12 digits.</div>
                    </div>
                    <hr>
                    <div class="alert alert-info">
                        <i class="bi bi-shield-lock-fill me-2"></i> This assessment is geo-locked. Your location has been verified.
                    </div>
                    
                    <button type="button" id="startBtn" class="btn btn-primary btn-lg w-100" onclick="startQuiz()" disabled>Start Assessment</button>
                </div>
            </div>

            <% if(assessment && assessment.questions && assessment.questions.length > 0) { %>
                <% assessment.questions.forEach((q, index) => { %>
                    <div class="card question-card" id="q-<%= index %>" data-index="<%= index %>">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between mb-3">
                                <span class="badge bg-secondary">Question <%= index + 1 %> of <%= assessment.questions.length %></span>
                                <span class="text-muted"><%= q.category_tag || 'General' %></span>
                            </div>
                            
                            <h4 class="mb-4"><%= q.question_text %></h4>

                            <% if(q.image_url) { %>
                                <img src="<%= q.image_url %>" class="img-fluid rounded mb-3" style="max-height: 300px;">
                            <% } %>

                            <div class="options-list">
                                <% q.options.forEach(opt => { %>
                                    <div>
                                        <input type="radio" name="answers[<%= q.id %>]" value="<%= opt.id %>" id="opt-<%= opt.id %>" class="option-input">
                                        <label class="option-label" for="opt-<%= opt.id %>"><%= opt.option_text %></label>
                                    </div>
                                <% }) %>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <% if(index > 0) { %>
                                    <button type="button" class="btn btn-outline-secondary btn-nav" onclick="showQuestion(<%= index - 1 %>)">Previous</button>
                                <% } else { %> <div></div> <% } %>

                                <% if(index < assessment.questions.length - 1) { %>
                                    <button type="button" class="btn btn-primary btn-nav" onclick="showQuestion(<%= index + 1 %>)">Next</button>
                                <% } else { %>
                                    <button type="button" class="btn btn-success btn-nav" onclick="submitAssessment()">Submit</button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="alert alert-warning text-center p-4">
                    <h4><i class="bi bi-exclamation-circle"></i> No Questions Found</h4>
                    <p>The assessment for <strong><%= training.theme %></strong> has been created, but no questions have been added yet.</p>
                </div>
            <% } %>

        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // 1. GEOLOCATION LOGIC
    window.onload = function() {
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const userLatInput = document.getElementById('userLat');
        const userLngInput = document.getElementById('userLng');
        const retryBtn = document.getElementById('retry-btn');

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLatInput.value = position.coords.latitude;
                    userLngInput.value = position.coords.longitude;
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                },
                (error) => {
                    console.error("Geo Error:", error);
                    document.getElementById('loading-text').innerText = "Location Access Denied";
                    document.getElementById('loading-subtext').innerText = "You must allow location access.";
                    document.querySelector('.spinner-border').style.display = 'none';
                    retryBtn.style.display = 'block';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            alert("Geolocation not supported.");
        }
    };

    // 2. QUIZ NAVIGATION
    function startQuiz() {
        document.getElementById('intro-card').style.display = 'none';
        const firstQ = document.getElementById('q-0');
        if(firstQ) firstQ.classList.add('active');
    }

    function showQuestion(index) {
        document.querySelectorAll('.question-card').forEach(c => c.classList.remove('active'));
        document.getElementById('q-' + index).classList.add('active');
    }

    // 3. SUBMISSION HANDLER (FIXED FOR STATELESS CERTIFICATE)
    async function submitAssessment() {
        if(!confirm("Are you sure you want to submit?")) return;

        const form = document.getElementById('assessmentForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Collect answers
        const answers = {};
        document.querySelectorAll('.option-input:checked').forEach(input => {
            const qId = input.name.match(/\[(.*?)\]/)[1]; 
            answers[qId] = input.value;
        });

        // Explicitly get the name for the certificate
        const pName = document.getElementById('participantName').value;

        const payload = {
            trainingId: data.trainingId,
            participantName: pName, 
            participantEmail: data.participantEmail,
            answers: answers,
            aadharId: data.aadharId,
            userLat: data.userLat,
            userLng: data.userLng
        };

        try {
            const response = await fetch('/assessment/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if(result.success) {
                // HIDE Form
                document.getElementById('assessmentForm').style.display = 'none';
                
                // SHOW Result Card
                const resultCard = document.getElementById('result-card');
                if(resultCard) {
                    resultCard.style.display = 'block';
                    
                    document.getElementById('score-display').innerText = result.score.toFixed(0) + '%';
                    
                    const messageEl = document.getElementById('result-message');
                    const certArea = document.getElementById('certificate-area');

                    if(result.score >= 60) {
                        messageEl.innerText = "Congratulations! You Passed.";
                        messageEl.className = "mb-3 text-success";
                        
                        // --- HERE IS THE FIX ---
                        // We construct the URL manually using the data sent back from the server
                        const certUrl = `/assessment/certificate?name=${encodeURIComponent(pName)}&score=${result.score}&training=${encodeURIComponent(result.trainingTitle)}&date=${encodeURIComponent(result.date)}`;
                        
                        certArea.innerHTML = `
                            <a href="${certUrl}" class="btn btn-success btn-lg">
                                <i class="bi bi-file-earmark-pdf-fill"></i> Download Certificate
                            </a>
                        `;
                    } else {
                        messageEl.innerText = "You need 60% to pass.";
                        messageEl.className = "mb-3 text-danger";
                        certArea.innerHTML = `<button class="btn btn-secondary" onclick="window.location.reload()">Retry Assessment</button>`;
                    }
                }
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error(error);
            alert('Submission failed due to network error.');
        }
    }

    // 4. VALIDATION LOGIC
    document.addEventListener('DOMContentLoaded', function() {
        const nameInput = document.getElementById('participantName');
        const emailInput = document.getElementById('participantEmail');
        const aadharInput = document.getElementById('aadharId');
        const startBtn = document.getElementById('startBtn'); 
        
        const allowedDomains = ['gov.in', 'nic.in', 'example.com', 'gmail.com']; 

        function validateForm() {
            if(!startBtn) return; 
            const isNameValid = nameInput.value.trim() !== '' && !nameInput.classList.contains('is-invalid');
            const isEmailValid = emailInput.value.trim() !== '' && !emailInput.classList.contains('is-invalid');
            const isAadharValid = aadharInput.value.length === 12;
            
            startBtn.disabled = !(isNameValid && isEmailValid && isAadharValid);
        }

        // Name Validation
        nameInput.addEventListener('input', function() {
            const regex = /^[a-zA-Z\s]+$/;
            if (this.value && !regex.test(this.value)) {
                this.classList.add('is-invalid');
                this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
            } else {
                this.classList.remove('is-invalid');
            }
            validateForm();
        });

        // Email Validation
        emailInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            const domain = val.split('@')[1];
            const isDomainAllowed = domain && allowedDomains.some(d => domain === d || domain.endsWith('.' + d));

            if (!isDomainAllowed && val.includes('@')) {
                this.classList.add('is-invalid');
                document.getElementById('emailFeedback').innerText = "Restricted Domain.";
            } else {
                this.classList.remove('is-invalid');
            }
            validateForm();
        });

        // Aadhar Validation
        aadharInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            validateForm();
        });
        
    });
</script>
</body>
</html>