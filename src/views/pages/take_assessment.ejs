<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .option-card {
            cursor: pointer;
            border: 2px solid #ddd;
            transition: all 0.3s;
        }
        .option-card:hover { border-color: #0d6efd; background: #f8f9fa; }
        .option-card.selected { border-color: #0d6efd; background: #e7f1ff; }
        .hidden { display: none; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-light">

    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h3>Verifying Location...</h3>
            <p class="text-muted">You must be at the training center to start.</p>
            <p id="gps-error" class="text-danger fw-bold"></p>
        </div>
    </div>

    <div class="container py-4" id="main-content" style="opacity: 0;">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><%= training.theme %> Assessment</h4>
                <small>Session ID: <%= training.session_code || 'OPEN' %></small>
            </div>
            <div class="card-body">
                
                <form id="assessmentForm">
                    <input type="hidden" name="trainingId" value="<%= training.id %>">
                    <input type="hidden" name="userLat" id="userLat">
                    <input type="hidden" name="userLng" id="userLng">

                    <div class="mb-4">
                        <label class="form-label">Full Name / à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®</label>
                        <input type="text" name="participantName" class="form-control form-control-lg" required>
                    </div>

                    <% assessment.questions.forEach((q, index) => { %>
                        <div class="mb-5 question-block">
                            
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-secondary me-2">Q<%= index + 1 %></span>
                                <h5 class="mb-0 me-auto"><%= q.question_text %></h5>
                                <% if(q.audio_url) { %>
                                    <button type="button" class="btn btn-sm btn-outline-info rounded-circle" onclick="playAudio('<%= q.audio_url %>')">
                                        ðŸ”Š
                                    </button>
                                <% } %>
                            </div>

                            <% if(q.image_url) { %>
                                <img src="<%= q.image_url %>" class="img-fluid rounded mb-3" style="max-height: 200px;">
                            <% } %>

                            <div class="row g-3">
                                <% q.options.forEach(opt => { %>
                                    <div class="col-6">
                                        <div class="card option-card h-100 p-3 text-center" onclick="selectOption('<%= q.id %>', '<%= opt.id %>', this)">
                                            <% if(opt.image_url) { %>
                                                <img src="<%= opt.image_url %>" class="img-fluid mb-2" style="height: 80px;">
                                            <% } %>
                                            <div><%= opt.option_text %></div>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                            <input type="hidden" name="answers[<%= q.id %>]" id="ans_<%= q.id %>" required>
                        </div>
                        <hr>
                    <% }) %>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">Submit Assessment / à¤œà¤®à¤¾ à¤•à¤°à¥‡à¤‚</button>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <script>
        // --- 1. THE GPS TRAP ---
        doocument.addEventListener('DOMContentLoaded', () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const latInput = document.getElementById('userLat');
        const lngInput = document.getElementById('userLng');
        function unlockAssessment(lat, lng) {
            latInput.value = lat;
            lngInput.value = lng;
            loadingOverlay.classList.add('hidden');
            mainContent.style.opacity = '1';
            // Optional: Alert to confirm it worked
            console.log("Assessment Unlocked for Testing"); 
        }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Success! Inject Coordinates
                        document.getElementById('userLat').value = position.coords.latitude;
                        document.getElementById('userLng').value = position.coords.longitude;
                        
                        // Unlock the screen
                        document.getElementById('loading-overlay').classList.add('hidden');
                        document.getElementById('main-content').style.opacity = '1';
                    },
                    (error) => {
                        // Failed! Block the user.
                        document.getElementById('gps-error').innerText = "Location Access Denied. You cannot take this test remotely.";
                    },
                    { enableHighAccuracy: true } // Force GPS (not just Wifi)
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });

        // --- 2. VISUAL SELECTION LOGIC ---
        function selectOption(qId, optId, cardElement) {
            // Update hidden input
            document.getElementById('ans_' + qId).value = optId;
            
            // Visual feedback (Highlight selected card)
            const parent = cardElement.closest('.row');
            parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');
        }

        // --- 3. AUDIO PLAYER ---
        function playAudio(url) {
            new Audio(url).play();
        }

        // --- 4. FORM SUBMISSION ---
        document.getElementById('assessmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Convert "answers[id]" keys back to a nested object if needed, 
            // or just send as flat keys. Ideally, format it for the controller.
            // For simplicity, let's just send JSON:
            
            const payload = {
                trainingId: data.trainingId,
                participantName: data.participantName,
                userLat: data.userLat,
                userLng: data.userLng,
                answers: {}
            };

            // Extract answers specifically
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('answers[')) {
                    const qId = key.match(/\[(.*?)\]/)[1];
                    payload.answers[qId] = value;
                }
            }

            const res = await fetch('/assessment/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            if (result.success) {
                alert(result.message); // "Submitted with Warnings" or "Success"
                window.location.href = '/participant/thank-you'; // Create this page later
            } else {
                alert('Error: ' + result.message);
            }
        });
    </script>
</body>
</html>