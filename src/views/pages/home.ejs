<!DOCTYPE html>
<html lang="<%= getLocale() %>">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= __('brand_name') %> - National Disaster Training Monitoring Portal</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Teko:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/home.css">

    <style>
        /* Chatbot Floating Widget */
        #sajag-chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            font-family: 'Inter', sans-serif;
        }

        #chatbot-toggle-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #f5a623; /* Sajag Theme Color */
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s, background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #chatbot-toggle-btn:hover {
            transform: scale(1.1);
            background-color: #e09210;
        }

        #chatbot-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 480px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }

        #chatbot-window.visible {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }

        .chat-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .chat-header i { margin-right: 8px; }

        .close-chat {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .close-chat:hover { opacity: 1; }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .bot-message {
            background: #e9ecef;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .user-message {
            background: #f5a623;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .chat-footer {
            padding: 12px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            background: white;
            align-items: center;
        }

        .chat-footer input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .chat-footer input:focus {
            border-color: #f5a623;
        }

        .chat-footer button {
            background: #2c3e50;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-footer button:hover {
            background: #1a252f;
        }
    </style>
</head>

<body>

    <nav id="sajagNavbar" class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/images/ndma.png" alt="NDMA Logo" class="brand-logo">
                <div class="brand-text-wrapper">
                    <span class="brand-name-en">SAJAG</span>
                    <span class="brand-name-hi">सजग</span>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item"><a class="nav-link" href="/"><%= __('nav_home') %></a></li>
                    <li class="nav-item"><a class="nav-link" href="#main-content"><%= __('nav_map') %></a></li>
                    <li class="nav-item"><a class="nav-link" href="/learn-public"><%= __('nav_learn') %></a></li>
                    <li class="nav-item"><a class="nav-link" href="#main-content"><%= __('nav_score') %></a></li>
                </ul>
                <div class="d-flex align-items-center mt-3 mt-lg-0">
                    <div class="dropdown me-3">
                        <% 
                            // This map connects the code 'ta' to the name 'தமிழ்'
                            const langNames = {
                                'en': 'English',
                                'hi': 'हिंदी',
                                'bn': 'বাংলা',
                                'ta': 'தமிழ்'
                            };
                            const currentLang = getLocale();
                        %>
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-globe"></i> <%= langNames[currentLang] || 'English' %>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="langDropdown">
                            <li><a class="dropdown-item" href="?lang=en">English</a></li>
                            <li><a class="dropdown-item" href="?lang=hi">हिंदी</a></li>
                            <li><a class="dropdown-item" href="?lang=bn">বাংলা</a></li>
                            <li><a class="dropdown-item" href="?lang=ta">தமிழ்</a></li>
                        </ul>
                    </div>

                    <% if (user) { %>
                        <a href="/dashboard" class="btn btn-register"><%= __('btn_dashboard') %></a>
                        <a href="/api/auth/logout" class="nav-link ms-3"><%= __('btn_logout') %></a>
                        <% } else { %>
                            <a href="/api/auth/login" class="nav-link me-3"><%= __('btn_login') %></a>
                            <a href="/api/auth/register" class="btn btn-register"><%= __('btn_register') %></a>
                            <% } %>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <section id="main-content" class="dashboard-section">
            <div class="container">
                <div class="ticker-bar animated">
                    <div class="ticker-label"><%= __('hero_ticker_label') %></div>
                    <div class="ticker-content">
                        <span>
                            Flood preparedness drill ongoing in Cuttack, Odisha &nbsp; • &nbsp; Earthquake safety
                            training completed in Guwahati, Assam &nbsp; • &nbsp; New landslide mitigation module added
                            to the Learn portal... &nbsp;
                        </span>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="map-card animated" style="transition-delay: 0.1s;">
                            <div class="btn-group map-filters" role="group" id="map-filter-group">
                                <button type="button" class="btn btn-sm active" data-filter="All"><%= __('map_filter_all') %></button>
                                <button type="button" class="btn btn-sm" data-filter="Earthquake"><%= __('map_filter_earthquake') %></button>
                                <button type="button" class="btn btn-sm" data-filter="Flood"><%= __('map_filter_flood') %></button>
                                <button type="button" class="btn btn-sm" data-filter="Cyclone"><%= __('map_filter_cyclone') %></button>
                                <button type="button" class="btn btn-sm" data-filter="Landslide"><%= __('map_filter_landslide') %></button>
                                <button type="button" class="btn btn-sm " data-filter="CBRN"><%= __('map_filter_cbrn') %></button>  
                            </div>
                            <div id="map" data-token="<%= MAPBOX_ACCESS_TOKEN %>"></div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="sidebar-widget animated" style="transition-delay: 0.2s;">
                            <h5 class="widget-title"><i class="fas fa-chart-line"></i><%= __('national_impact') %></h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="stat-card">
                                        <div class="stat-number"
                                            data-target="<%= typeof totalTrainings !== 'undefined' ? totalTrainings : 0 %>">
                                            <%= typeof totalTrainings !=='undefined' ? totalTrainings : 0 %>
                                        </div>
                                        <div class="stat-label"><%= __('hero_stat_trainings') %></div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card">
                                        <div class="stat-number"
                                            data-target="<%= typeof totalParticipants !== 'undefined' ? totalParticipants : 0 %>">
                                            <%= typeof totalParticipants !=='undefined' ? totalParticipants : 0 %>
                                        </div>
                                        <div class="stat-label"><%= __('hero_stat_participants') %></div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card">
                                        <div class="stat-number"
                                            data-target="<%= typeof activePartners !== 'undefined' ? activePartners : 0 %>">
                                            <%= typeof activePartners !=='undefined' ? activePartners : 0 %>
                                        </div>
                                        <div class="stat-label"><%= __('hero_stat_partners') %></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-widget animated" style="transition-delay: 0.3s;"
                            id="lookup-section-sidebar">
                            <%# Changed ID slightly to avoid conflict if needed %>
                                <h5 class="widget-title"><i class="fas fa-clipboard-check"></i> <%= __('lookup_title') %></h5>
                                <p class="section-subtitle mb-3" style="font-size: 0.9rem;"><%= __('lookup_subtitle') %></p>
                                <%# Adjusted text style/margin %>
                                    <div class="card lookup-card" id="lookupCard">
                                       <form id="lookupForm">
                                            <div class="input-group">
                                
                <input type="email" class="form-control form-control-md" name="email"
                                                    placeholder="<%= __('lookup_placeholder') %>" required>
                          
                       <%# Adjusted placeholder/size %>
                                                    <button class="btn btn-register btn-md" type="submit"><%= __('lookup_btn') %></button> <%# Adjusted size/text %>
       
                                     </div>
                                        </form>
                                        <div id="lookupMessage" class="mt-2" style="font-size: 0.85rem;"></div>
                                        <%# Adjusted margin/size %>
                                    </div>
                        </div>
                    </div>
        </section>
        <section class="training-list-section py-5" style="background-color: #f8f9fa;">
    <div class="container">
        <div class="row g-4">
            
            <div class="col-lg-6 animated">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                        <h4 class="card-title fw-bold text-success">
                            <i class="fas fa-satellite-dish me-2"></i> Active Trainings
                        </h4>
                    </div>
                    <div class="card-body px-4">
                        <% if (typeof activeTrainings !== 'undefined' && activeTrainings.length > 0) { %>
                            <div class="list-group list-group-flush">
                                <% activeTrainings.forEach(function(t) { %>
                                    <div class="list-group-item px-0 py-3">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1 fw-bold"><%= t.title %></h6>
                                                <p class="mb-1 text-muted small">
                                                    <i class="fas fa-map-marker-alt text-danger me-1"></i> 
                                                    <%= t.location_text %>
                                                </p>
                                                <span class="badge bg-secondary text-light"><%= t.theme %></span>
                                            </div>
                                            <button class="btn btn-sm btn-outline-primary ms-2" 
                                                    onclick="viewOnMap(<%= t.latitude %>, <%= t.longitude %>)">
                                                <i class="fas fa-crosshairs"></i> View
                                            </button>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-info-circle mb-2"></i><br>
                                No active trainings at this moment.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 animated" style="transition-delay: 0.1s;">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                        <h4 class="card-title fw-bold text-primary">
                            <i class="fas fa-calendar-alt me-2"></i> Upcoming Trainings
                        </h4>
                    </div>
                    <div class="card-body px-4">
                        <% if (typeof upcomingTrainings !== 'undefined' && upcomingTrainings.length > 0) { %>
                            <div class="list-group list-group-flush">
                                <% upcomingTrainings.slice(0, 5).forEach(function(t) { %> 
                                <div class="list-group-item px-0 py-3">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1 fw-bold"><%= t.title %></h6>
                                                <p class="mb-1 text-muted small">
                                                    <i class="fas fa-clock me-1"></i> Starts: <%= t.startDateFormatted %>
                                                    <br>
                                                    <i class="fas fa-map-marker-alt text-danger me-1"></i> <%= t.location_text %>
                                                </p>
                                            </div>
                                            <button class="btn btn-sm btn-outline-primary ms-2" 
                                                    onclick="viewOnMap(<%= t.latitude %>, <%= t.longitude %>)">
                                                <i class="fas fa-crosshairs"></i> View
                                            </button>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-calendar-times mb-2"></i><br>
                                No upcoming trainings scheduled soon.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<section class="about-section">
    ```

        <section class="about-section">
            <div class="container">
                <h2 class="section-title-light animated"><%= __('about_title') %></h2>
                <p class="section-subtitle-light animated"><%= __('about_subtitle') %></p>

                <div class="process-flow animated" style="transition-delay: 0.2s;">
                    <svg class="flow-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 10"
                        preserveAspectRatio="none">
                        <path d="M 5,5 Q 30,0 50,5 T 95,5" stroke="rgba(245, 166, 35, 0.5)" stroke-width="1.5"
                            fill="none" stroke-linecap="round" />
                    </svg>

                    <div class="process-step">
                        <div class="process-icon"><i class="fas fa-handshake-angle"></i></div>
                        <h4 class="process-title"><%= __('step_onboarding') %></h4>
                        <p class="process-text"><%= __('step_onboarding_desc') %></p>
                    </div>
                    <div class="process-step">
                        <div class="process-icon"><i class="fas fa-chalkboard-user"></i></div>
                        <h4 class="process-title"><%= __('step_training') %></h4>
                        <p class="process-text"><%= __('step_training_desc') %></p>
                    </div>
                    <div class="process-step">
                        <div class="process-icon"><i class="fas fa-map-marked-alt"></i></div>
                        <h4 class="process-title"><%= __('step_monitor') %></h4>
                        <p class="process-text"><%= __('step_monitor_desc') %></p>
                    </div>
                    <div class="process-step">
                        <div class="process-icon"><i class="fas fa-clipboard-check"></i></div>
                        <h4 class="process-title"><%= __('step_assess') %></h4>
                        <p class="process-text"><%= __('step_assess_desc') %></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="learn-section" class="py-5">
            <div class="container">
                <div class="text-center mb-5 animated">
                    <h2 class="section-title"><%= __('learn_title') %></h2>
                    <p class="section-subtitle"><%= __('learn_subtitle') %></p>
                </div>
                <div class="row g-4">
                    <div class="col-md-4 animated" style="transition-delay: 0.1s;">
                        <a href="/learn-public" class="learn-card">
                            <div class="learn-icon"><i class="fas fa-house-flood-water"></i></div>
                            <h3 class="learn-title"><%= __('learn_card_flood') %></h3>
                            <p class="learn-text"><%= __('learn_card_flood_desc') %></p>
                        </a>
                    </div>
                    <div class="col-md-4 animated" style="transition-delay: 0.2s;">
                        <a href="/learn-public" class="learn-card">
                            <div class="learn-icon"><i class="fas fa-house-crack"></i></div>
                            <h3 class="learn-title"><%= __('learn_card_quake') %></h3>
                            <p class="learn-text"><%= __('learn_card_quake_desc') %></p>
                        </a>
                    </div>
                    <div class="col-md-4 animated" style="transition-delay: 0.3s;">
                        <a href="/learn-public" class="learn-card">
                            <div class="learn-icon"><i class="fas fa-kit-medical"></i></div>
                            <h3 class="learn-title"><%= __('learn_card_firstaid') %></h3>
                            <p class="learn-text"><%= __('learn_card_firstaid_desc') %></p>
                        </a>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="sajag-chatbot-container">
        <button id="chatbot-toggle-btn" onclick="toggleChat()">
            <i class="fas fa-robot"></i>
        </button>
    
        <div id="chatbot-window">
            <div class="chat-header">
                <span><i class="fas fa-shield-alt"></i> SAJAG Sahayak</span>
                <button onclick="toggleChat()" class="close-chat"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-body" id="chat-messages">
                <div class="message bot-message">
                    नमस्ते! मैं सजग सहायक हूँ। आपदा प्रबंधन (Disaster Management) या सुरक्षा से जुड़ा कोई भी सवाल पूछें।
                </div>
            </div>
            <div class="chat-footer">
                <input type="text" id="user-input" placeholder="Ask about floods, earthquake safety..." onkeypress="handleEnter(event)">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <img src="/images/ndma.png" alt="NDMA Logo" class="footer-logo">
            <p>&copy; <%= new Date().getFullYear() %> Project SAJAG | National Disaster Management Authority, Government
                    of India.</p>
            <a href="#" class="footer-link">Back to Top</a>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <script src="/js/participant.js"></script>
    <script src="/js/ticker.js"></script>
    <script src="/js/home.js"></script>
    <script src="/js/publicMap.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Scroll-triggered animations
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.animated').forEach(el => {
                observer.observe(el);
            });

            // Smooth scrolling for nav links
            document.querySelectorAll('a.nav-link[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });
        });

        // --- CHATBOT JS LOGIC (STEP 5 Included Here) ---
        function toggleChat() {
            const chatWindow = document.getElementById('chatbot-window');
            chatWindow.classList.toggle('visible');
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const message = inputField.value.trim();
            const chatBody = document.getElementById('chat-messages');

            if (!message) return;

            // 1. User Message Display
            appendMessage(message, 'user-message');
            inputField.value = '';

            // 2. Show Loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message';
            loadingDiv.textContent = 'Typing...';
            loadingDiv.id = 'loading-msg';
            chatBody.appendChild(loadingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;

            try {
                // 3. Backend API Call
                const response = await fetch('/api/chat-public', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                
                // 4. Remove Loading & Show Response
                if(document.getElementById('loading-msg')) {
                    document.getElementById('loading-msg').remove();
                }
                
                if (data.error) {
                     appendMessage("Error: " + data.error, 'bot-message');
                } else {
                     appendMessage(data.reply, 'bot-message');
                }

            } catch (error) {
                if(document.getElementById('loading-msg')) {
                    document.getElementById('loading-msg').remove();
                }
                appendMessage("माफ़ कीजिये, अभी संपर्क नहीं हो पा रहा है।", 'bot-message');
                console.error(error);
            }
        }

        function appendMessage(text, className) {
            const chatBody = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${className}`;
            
            // Allow basic bold formatting if needed, but for security usually innerText is better.
            // Converting **text** to <b>text</b> for basic markdown support if Gemini sends it.
            const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            msgDiv.innerHTML = formattedText; 
            
            chatBody.appendChild(msgDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    </script>
</body>

</html>